<html>
<head>
    <title>PixiJS Test</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/style.css">
    <script src="lib/pixi.js"></script>
    <script src="lib/kotlin.js"></script>
    <script src="lib/twf.js"></script>
</head>
<body>
    <canvas id="mainCanvas"></canvas>
    <script type="text/javascript">
        const canvas = document.getElementById("mainCanvas");
        const renderer = new PIXI.Renderer({
            view: canvas,
            resolution: 1
        });

        var style = new PIXI.TextStyle({
            fontFamily: 'Comic Sans MS',
            fontSize: 24,
            fill: 0xffffff
        })

        var extraSettings = {
            divisionLineExtraLength: 4,    // used for managing "multi-floor" fractions
            divisionLineWidth: 3,   // division line thickness
        }

        var testTaskString = "a+(b/(c-12))/24";
        var testTaskString = "a+(b/(c-12))/(24/48)";
        var expressionRoot = twf.api.stringToExpression(testTaskString);
        var containerRoot = outputReactiveExpression(expressionRoot);
        console.log(expressionRoot);
        console.log(containerRoot);

        animate();

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(containerRoot);
        }

        function outputReactiveExpression(expressionNode) {
            var outputContainer = makeReactiveExpression(0, 0, expressionNode);
            outputContainer.position.set((renderer.width-outputContainer.width)/2, renderer.height/2);
            return outputContainer;
        }

        function makeReactiveExpression(x, y, expressionNode) {
            var container = new PIXI.Container();
            container.x = x;
            container.y = y;
            var children = expressionNode.children.array_hd7ov6$_0;
            var type = expressionNode.nodeType.name$;
            var value = expressionNode.value;
            container.expressionTreeNodeId = expressionNode.nodeId;
            if (type === "VARIABLE") {  // ATTENTION: currently implies not having children
                var text = new PIXI.Text(value, style);
                container.addChild(text);
                return makeResponsiveContainer(container);
            }
            else if (type === "FUNCTION") {   // ATTENTION: currently implies having 1 or 2 children, depending on the function
                switch(value) {
                    case "+":   // TODO: need to support more than 2 components (refer to comment on line 71)
                        var left_part = makeReactiveExpression(0, 0, expressionNode.children.array_hd7ov6$_0[0]);
                        if (expressionNode.children.array_hd7ov6$_0[1].value === "-") { // if right child is -(<some_expression>), then we shouldn't draw a "+"
                            var textBlockWidth = 0;
                            var textBlockHeight = 0;
                        } else {
                            var text = new PIXI.Text("+", style);
                            text.position.set(left_part.width, 0);
                            var textBlockWidth = PIXI.TextMetrics.measureText("+", style).width;
                            var textBlockHeight = PIXI.TextMetrics.measureText("+", style).height;
                        }
                        var right_part = makeReactiveExpression(left_part.width+textBlockWidth, 0, expressionNode.children.array_hd7ov6$_0[1]);

                        container.addChild(left_part);
                        if (expressionNode.children.array_hd7ov6$_0[1].value !== "-")
                            container.addChild(text);
                        container.addChild(right_part);
                        break;

                    case "-":
                        var text = new PIXI.Text("-", style);
                        text.position.set(0, 0);
                        var textBlockWidth = PIXI.TextMetrics.measureText("-", style).width;
                        var textBlockHeight = PIXI.TextMetrics.measureText("-", style).height;
                        var variable_part = makeReactiveExpression(textBlockWidth, 0, expressionNode.children.array_hd7ov6$_0[0]);
                        
                        container.addChild(text);
                        container.addChild(variable_part);
                        break;

                    case "*":
                        var left_part = makeReactiveExpression(0, 0, expressionNode.children.array_hd7ov6$_0[0]);
                        var text = new PIXI.Text("*", style);
                        text.position.set(left_part.width, 0);
                        var textBlockWidth = PIXI.TextMetrics.measureText("*", style).width;
                        var textBlockHeight = PIXI.TextMetrics.measureText("*", style).height;
                        var right_part = makeReactiveExpression(left_part.width+textBlockWidth, 0, expressionNode.children.array_hd7ov6$_0[1]);

                        container.addChild(left_part);
                        container.addChild(text);
                        container.addChild(right_part);
                        break;

                    case "/":
                        var numerator = makeReactiveExpression(0, 0, expressionNode.children.array_hd7ov6$_0[0]);
                        var denominator = makeReactiveExpression(0, numerator.height+extraSettings.divisionLineWidth, expressionNode.children.array_hd7ov6$_0[1]);

                        var fractionLength = Math.max(numerator.width, denominator.width)+extraSettings.divisionLineExtraLength;
                        var fractionHeight = numerator.width+numerator.height+extraSettings.divisionLineWidth;
                        var numeratorOffset = (fractionLength-numerator.width)/2;
                        var denominatorOffset = (fractionLength-denominator.width)/2;
                        numerator.x += numeratorOffset;
                        denominator.x += denominatorOffset;
                        if (["+", "*"].includes(expressionNode.parent.value))   // ATTENTION: puts the fraction higher in order to line up with the whole expression
                            container.y -= fractionHeight/2;

                        var divisionLine = new PIXI.Graphics();
                        divisionLine.lineStyle(extraSettings.divisionLineWidth, 0xffffff);
                        divisionLine.moveTo(0, numerator.height);
                        divisionLine.lineTo(fractionLength, numerator.height);
                        divisionLine.closePath();

                        container.addChild(numerator);
                        container.addChild(denominator);
                        container.addChild(divisionLine);
                        break;

                    default:    // ATTENTION: currectly means only full expression (what if brackets?)
                        var fullContainer = makeReactiveExpression(0, 0, expressionNode.children.array_hd7ov6$_0[0]);
                        container.addChild(fullContainer);
                }
            }

            return container;
        }

        function makeResponsiveContainer(container) {
            container.interactive = true;
            container.buttonMode = true;
            container.hitArea = new PIXI.Rectangle(0, 0, container.width, container.height);
            container.on("click", returnNodeId);
            var highlightRect = new PIXI.Graphics();
            highlightRect.lineStyle(0, 0xffffff);
            highlightRect.beginFill(0xffffff);
            highlightRect.drawRect(0, 0, container.width, container.height);
            highlightRect.endFill();
            highlightRect.alpha = 0;

            container.mouseover = function(mouseData) {
                // add nodeId reaction and stuff
                highlightRect.alpha = 0.4;
            }

            container.mouseout = function(mouseData) {
                // add nodeId reaction and stuff
                highlightRect.alpha = 0;
            }

            function returnNodeId() {
                console.log(container.expressionTreeNodeId);    // for testing purposes
            }

            container.addChild(highlightRect);
            return container;
        }
    </script>
</body>
</html>